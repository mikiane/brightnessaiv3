<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat RAG</title>
  <style>
    :root{ --bg:#0B0B0C; --panel:#15161A; --muted:#24262B; --text:#E8E9EC; --accent:#D73C2C; --subtle:#9AA0A6; --radius:10px; --shadow:0 4px 20px rgba(0,0,0,.35); }
    body{margin:0; background:var(--bg); color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{display:flex; flex-direction:column; min-height:100vh}
    header{display:flex; gap:10px; align-items:center; padding:10px 14px; border-bottom:1px solid var(--muted); background:var(--panel)}
    header img{height:28px}
    main{flex:1; display:flex; flex-direction:column; max-width:900px; margin:0 auto; width:100%}
    .chat{flex:1; padding:14px; overflow:auto}
    .msg{display:flex; gap:10px; margin:10px 0}
    .role{width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff}
    .role.user{background:#3A3F46}
    .role.assistant{background:var(--accent)}
    .content{max-width:100%}
    .content.user{white-space:pre-wrap}
    .content.md{white-space:normal}
    .content.md pre{background:#0f1115; border:1px solid var(--muted); padding:10px; overflow:auto; border-radius:6px}
    .content.md code{background:#0f1115; padding:2px 4px; border-radius:4px}
    .content.md ul, .content.md ol{margin:8px 0 8px 22px}
    .composer{padding:10px 14px; border-top:1px solid var(--muted); background:var(--panel)}
    .row{display:flex; gap:10px; align-items:center}
    textarea{flex:1; resize:vertical; min-height:60px; max-height:40vh; border:1px solid var(--muted); background:var(--panel); color:var(--text); border-radius:var(--radius); padding:10px; box-shadow:var(--shadow)}
    .btn{border:1px solid var(--muted); background:var(--panel); color:var(--text); padding:10px 12px; border-radius:var(--radius); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, var(--accent), #b32f23); border:none; color:#fff}
    .hidden{display:none}
    .hint{color:var(--subtle); font-size:12px}
    /* Bloc source (contexte) */
    .source{border:1px solid var(--muted); border-radius:8px; margin-top:8px; overflow:hidden; background:rgba(255,255,255,.02)}
    .source-toggle{padding:3px 6px; font-size:11px; color:var(--subtle); cursor:pointer; user-select:none; background:transparent}
    .source-toggle:hover{color:#C2C7CE}
    .source-panel{display:none; padding:8px 10px; color:var(--subtle); font-size:12px; line-height:1.35}
    .source.open .source-panel{display:block}
    .sec-title{font-weight:600; font-size:11px; color:#80868b; text-transform:uppercase; letter-spacing:.3px}
    .chunk{border:1px dashed #2a2d33; border-radius:6px; padding:6px; margin-top:6px; background:transparent}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <img id="logo" alt="logo" />
    <div id="title">Chat RAG</div>
  </header>
  <main>
    <section id="chat" class="chat" aria-live="polite"></section>
  </main>
  <footer class="composer">
    <div class="row">
      <textarea id="input" placeholder="Votre question… (Entrée = envoyer)"></textarea>
      <button id="send" class="btn primary">Envoyer</button>
    </div>
    <div class="row"><span id="status" class="hint"></span></div>
  </footer>
</div>
<script>
(function(){
  const els = { logo:document.getElementById('logo'), title:document.getElementById('title'), chat:document.getElementById('chat'), input:document.getElementById('input'), send:document.getElementById('send'), status:document.getElementById('status') };

  let cfg = { title:'Chat RAG', logoUrl:'', apiUrl:'', searchUrl:'', apiKey:'', brain_id:'', model:'', temperature:0, withHistory:true, system:'', consigne:'', activate_source:false };

  async function loadConfig(){
    const params=new URLSearchParams(window.location.search); const idx=params.get('index'); let cfgFile='chat-config.json';
    if(idx){ const safe=idx.match(/^[a-zA-Z0-9_-]+(\.json)?$/)?idx:null; if(safe) cfgFile=safe.endsWith('.json')?safe:`${safe}.json`; }
    try{ const res=await fetch(cfgFile,{cache:'no-store'}); if(!res.ok) throw 0; cfg={...cfg,...(await res.json())}; }catch(e){ try{ const r2=await fetch('chat-config.json',{cache:'no-store'}); if(r2.ok) cfg={...cfg,...(await r2.json())}; }catch(_){} }
    if(cfg.title) els.title.textContent=cfg.title; if(cfg.logoUrl) els.logo.src=cfg.logoUrl; else els.logo.classList.add('hidden');
    if(!cfg.apiUrl) els.status.textContent='Configuration manquante: apiUrl'; if(!cfg.searchUrl) els.status.textContent='Configuration manquante: searchUrl'; if(!cfg.brain_id) els.status.textContent='Configuration manquante: brain_id';
  }

  function atBottom(c,t=40){ return c.scrollHeight-c.scrollTop-c.clientHeight<t; }
  function autoScroll(){ els.chat.scrollTop=els.chat.scrollHeight; }
  function $(tag, attrs={}, text=''){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>n.setAttribute(k,v)); if(text) n.textContent=text; return n; }
  function renderMessage(role, content){
    const container=$('div',{class:'msg'});
    const roleEl=$('div',{class:'role '+(role==='assistant'?'assistant':'user')}); roleEl.textContent=role==='assistant'?'AI':'Vous';
    const textEl=$('div',{class:'content '+(role==='assistant'?'md':'user')}); if(role==='assistant') textEl.innerHTML=''; else textEl.textContent=content||'';
    container.appendChild(roleEl); container.appendChild(textEl); els.chat.appendChild(container); if(atBottom(els.chat)) autoScroll();
    return { textEl, container };
  }

  function createSourceBlock(contextText, histText){
    const wrap=$('div',{class:'source'}); const toggle=$('div',{class:'source-toggle'},'source'); const panel=$('div',{class:'source-panel'});
    const histTitle=$('div',{class:'sec-title'},'Historique'); const hist=$('div',{class:'chunk'}); hist.textContent=(histText||'(vide)'); panel.appendChild(histTitle); panel.appendChild(hist);
    const parts=Array.isArray(contextText)?contextText: typeof contextText==='string'?contextText.split(/\n\s*\n+/):[String(contextText||'')];
    const exTitle=$('div',{class:'sec-title'},`Extraits (${parts.length})`); panel.appendChild(exTitle);
    parts.forEach(p=>{ const c=$('div',{class:'chunk'}); c.textContent=p.trim(); panel.appendChild(c); });
    toggle.addEventListener('click',()=>wrap.classList.toggle('open')); wrap.appendChild(toggle); wrap.appendChild(panel); return wrap;
  }

  const history=[];
  function buildConsigne(base, hist){ if(!cfg.withHistory||hist.length===0) return base||''; const last=hist.slice(-4).map(m=>`- ${m.role}: ${m.content}`).join('\n'); return `${base||''}\n\nContexte conversationnel:\n${last}`.trim(); }

  async function fetchContext(q){ const fd=new FormData(); fd.append('request',q); fd.append('brain_id',cfg.brain_id); if(cfg.model) fd.append('model',cfg.model); const headers={}; if(cfg.apiKey) headers['X-API-Key']=cfg.apiKey; const res=await fetch(cfg.searchUrl,{method:'POST',body:fd,headers}); if(!res.ok) throw new Error('searchcontext HTTP '+res.status); const data=await res.json(); const ans=Array.isArray(data)?data[0]?.answer:data?.[0]?.answer; return ans||''; }

  async function sendToLLM(question, extraContext){
    const headers={'Content-Type':'application/json','Accept':'text/plain'}; if(cfg.apiKey) headers['X-API-Key']=cfg.apiKey;
    const contextualConsigne=`${buildConsigne(cfg.consigne,history)}\n\nVoici un contexte à prendre en compte <<<Contexte>>>\n${extraContext}`;
    const payload={ consigne:encodeURIComponent(contextualConsigne), texte:encodeURIComponent(question), system:cfg.system||'', model:cfg.model||undefined, temperature:String(Number(cfg.temperature||0).toFixed(2)) };
    const res=await fetch(cfg.apiUrl,{method:'POST',headers,body:JSON.stringify(payload),mode:'cors',credentials:'omit'}); if(!res.ok||!res.body) throw new Error('LLM HTTP '+res.status); return res.body.getReader();
  }

  async function handleSend(){
    const q=els.input.value.trim(); if(!q) return; els.input.value=''; els.input.focus();
    renderMessage('user', q); history.push({role:'user', content:q});
    const { textEl, container }=renderMessage('assistant',''); els.status.textContent='';
    try{
      const context=await fetchContext(q);
      const reader=await sendToLLM(q, context); const decoder=new TextDecoder(); let done=false; let acc='';
      while(!done){ const chunk=await reader.read(); done=chunk.done; if(chunk.value){ const t=decoder.decode(chunk.value,{stream:true}); acc+=t; const html=DOMPurify.sanitize(marked.parse(acc)); textEl.innerHTML=html; autoScroll(); } }
      history.push({role:'assistant', content:textEl.textContent});
      if (cfg.activate_source) {
        const histText=history.slice(-5,-1).map(m=>`- ${m.role}: ${m.content}`).join('\n');
        container.appendChild(createSourceBlock(context, histText));
      }
    }catch(e){ textEl.textContent=(textEl.textContent||'')+`\n[Erreur] ${e.message||e}`; }
  }

  els.send.addEventListener('click', handleSend);
  els.input.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); handleSend(); } });

  loadConfig();
})();
</script>
</body>
</html>
