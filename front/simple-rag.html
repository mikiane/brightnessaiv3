<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat RAG</title>
  <style>
    :root{ --bg:#0B0B0C; --panel:#15161A; --muted:#24262B; --text:#E8E9EC; --accent:#D73C2C; --subtle:#9AA0A6; --radius:10px; --shadow:0 4px 20px rgba(0,0,0,.35); }
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{display:flex; flex-direction:column; min-height:100vh}
    header{display:flex; gap:10px; align-items:center; padding:10px 14px; border-bottom:1px solid var(--muted); background:var(--panel)}
    header img{height:28px}
    main{flex:1; display:flex; flex-direction:column; max-width:900px; margin:0 auto; width:100%}
    .chat{flex:1; padding:14px; overflow:auto}
    .msg{display:flex; gap:10px; margin:10px 0}
    .role{width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff}
    .role.user{background:#3A3F46}
    .role.assistant{background:var(--accent)}
    .content{max-width:100%}
    .content.user{white-space:pre-wrap}
    .content.md{white-space:normal}
    .content.md pre{background:#0f1115; border:1px solid var(--muted); padding:10px; overflow:auto; border-radius:6px}
    .content.md code{background:#0f1115; padding:2px 4px; border-radius:4px}
    .content.md ul, .content.md ol{margin:8px 0 8px 22px}
    .content.md a{color:var(--accent); font-weight:700; text-decoration:none}
    .content.md a:hover{text-decoration:underline}
    .composer{padding:10px 14px; border-top:1px solid var(--muted); background:var(--panel)}
    .row{display:flex; gap:10px; align-items:center}
    textarea{flex:1; resize:vertical; min-height:60px; max-height:40vh; border:1px solid var(--muted); background:var(--panel); color:var(--text); border-radius:var(--radius); padding:10px; box-shadow:var(--shadow)}
    .btn{border:1px solid var(--muted); background:var(--panel); color:var(--text); padding:10px 12px; border-radius:var(--radius); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, var(--accent), #b32f23); border:none; color:#fff}
    .hidden{display:none}
    .hint{color:var(--subtle); font-size:12px}
    /* Bloc source (contexte) */
    .source{border:1px solid var(--muted); border-radius:8px; margin-top:8px; overflow:hidden; background:rgba(255,255,255,.02)}
    .source-toggle{padding:3px 6px; font-size:11px; color:var(--subtle); cursor:pointer; user-select:none; background:transparent}
    .source-toggle:hover{color:#C2C7CE}
    .source-panel{display:none; padding:8px 10px; color:var(--subtle); font-size:12px; line-height:1.35}
    .source.open .source-panel{display:block}
    .sec-title{font-weight:600; font-size:11px; color:#80868b; text-transform:uppercase; letter-spacing:.3px}
    .chunk{border:1px dashed #2a2d33; border-radius:6px; padding:6px; margin-top:6px; background:transparent}
    /* Typing indicator */
    .typing{display:inline-flex;gap:4px;align-items:center;margin-top:4px}
    .typing .dot{width:6px;height:6px;background:#9AA0A6;border-radius:50%;opacity:.3;animation:blink 1.2s infinite}
    .typing .dot:nth-child(2){animation-delay:.2s}
    .typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <img id="logo" alt="logo" />
    <div id="title">Chat RAG</div>
  </header>
  <main>
    <section id="chat" class="chat" aria-live="polite"></section>
  </main>
  <footer class="composer">
    <div class="row">
      <textarea id="input" placeholder="Votre questionâ€¦ (EntrÃ©e = envoyer)"></textarea>
      <button id="stop" class="btn hidden">Stop</button>
      <button id="send" class="btn primary">Envoyer</button>
    </div>
    <div class="row"><span id="status" class="hint"></span></div>
  </footer>
</div>
<script>
(function(){
  const els = { logo:document.getElementById('logo'), title:document.getElementById('title'), chat:document.getElementById('chat'), input:document.getElementById('input'), send:document.getElementById('send'), stop:document.getElementById('stop'), status:document.getElementById('status') };
  let abortController = null;

  let cfg = { title:'Chat RAG', logoUrl:'', apiUrl:'', searchUrl:'', apiKey:'', brain_id:'', model:'', temperature:0, withHistory:true, system:'', consigne:'', activate_source:false, initialisation:'' };

  async function loadConfig(){
    const params=new URLSearchParams(window.location.search); const idx=params.get('index'); let cfgFile='chat-config.json';
    if(idx){ const safe=idx.match(/^[a-zA-Z0-9_-]+(\.json)?$/)?idx:null; if(safe) cfgFile=safe.endsWith('.json')?safe:`${safe}.json`; }
    try{ const res=await fetch(cfgFile,{cache:'no-store'}); if(!res.ok) throw 0; cfg={...cfg,...(await res.json())}; }catch(e){ try{ const r2=await fetch('chat-config.json',{cache:'no-store'}); if(r2.ok) cfg={...cfg,...(await r2.json())}; }catch(_){} }
    if(cfg.title) els.title.textContent=cfg.title; if(cfg.logoUrl) els.logo.src=cfg.logoUrl; else els.logo.classList.add('hidden');
    if(!cfg.apiUrl) els.status.textContent='Configuration manquante: apiUrl'; if(!cfg.searchUrl) els.status.textContent='Configuration manquante: searchUrl'; if(!cfg.brain_id) els.status.textContent='Configuration manquante: brain_id';
  }

  function atBottom(c,t=40){ return c.scrollHeight-c.scrollTop-c.clientHeight<t; }
  function autoScroll(){ els.chat.scrollTop=els.chat.scrollHeight; }
  function $(tag, attrs={}, text=''){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>n.setAttribute(k,v)); if(text) n.textContent=text; return n; }
  function renderMessage(role, content){
    const container=$('div',{class:'msg'});
    const roleEl=$('div',{class:'role '+(role==='assistant'?'assistant':'user')}); roleEl.textContent=role==='assistant'?'AI':'Vous';
    const contentEl=$('div');
    const textEl=$('div',{class:'content '+(role==='assistant'?'md':'user')}); if(role==='assistant') textEl.innerHTML=''; else textEl.textContent=content||'';
    contentEl.appendChild(textEl);
    container.appendChild(roleEl); container.appendChild(contentEl); els.chat.appendChild(container); if(atBottom(els.chat)) autoScroll();
    return { textEl, container, contentEl };
  }

  function createSourceBlock(contextText, histText){
    const wrap=$('div',{class:'source'}); const toggle=$('div',{class:'source-toggle'},'source'); const panel=$('div',{class:'source-panel'});
    const histTitle=$('div',{class:'sec-title'},'Historique'); const hist=$('div',{class:'chunk'}); hist.textContent=(histText||'(vide)'); panel.appendChild(histTitle); panel.appendChild(hist);
    const parts=Array.isArray(contextText)?contextText: typeof contextText==='string'?contextText.split(/\n\s*\n+/):[String(contextText||'')];
    const exTitle=$('div',{class:'sec-title'},`Extraits (${parts.length})`); panel.appendChild(exTitle);
    parts.forEach(p=>{ const c=$('div',{class:'chunk'}); c.textContent=p.trim(); panel.appendChild(c); });
    toggle.addEventListener('click',()=>wrap.classList.toggle('open')); wrap.appendChild(toggle); wrap.appendChild(panel); return wrap;
  }

  const history=[];
  function buildConsigne(base, hist){ if(!cfg.withHistory||hist.length===0) return base||''; const last=hist.slice(-4).map(m=>`- ${m.role}: ${m.content}`).join('\n'); return `${base||''}\n\nContexte conversationnel:\n${last}`.trim(); }

  async function fetchContext(q){ const fd=new FormData(); fd.append('request',q); fd.append('brain_id',cfg.brain_id); if(cfg.model) fd.append('model',cfg.model); const headers={}; if(cfg.apiKey) headers['X-API-Key']=cfg.apiKey; const res=await fetch(cfg.searchUrl,{method:'POST',body:fd,headers,signal:abortController?.signal}); if(!res.ok) throw new Error('searchcontext HTTP '+res.status); const data=await res.json(); const ans=Array.isArray(data)?data[0]?.answer:data?.[0]?.answer; return ans||''; }

  async function sendToLLM(question, extraContext){
    const headers={'Content-Type':'application/json','Accept':'text/plain'}; if(cfg.apiKey) headers['X-API-Key']=cfg.apiKey;
    const contextualConsigne=`${buildConsigne(cfg.consigne,history)}\n\nVoici un contexte Ã  prendre en compte <<<Contexte>>>\n${extraContext}`;
    const payload={ consigne:encodeURIComponent(contextualConsigne), texte:encodeURIComponent(question), system:cfg.system||'', model:cfg.model||undefined, temperature:String(Number(cfg.temperature||0).toFixed(2)) };
    const res=await fetch(cfg.apiUrl,{method:'POST',headers,body:JSON.stringify(payload),mode:'cors',credentials:'omit',signal:abortController?.signal}); if(!res.ok||!res.body) throw new Error('LLM HTTP '+res.status); return res.body.getReader();
  }

  async function handleSend(){
    const q=els.input.value.trim(); if(!q) return; 
    els.input.value=''; els.input.focus();
    renderMessage('user', q); history.push({role:'user', content:q});
    const { textEl, container, contentEl }=renderMessage('assistant','');
    
    // Ajoute l'indicateur de typing
    const typing = document.createElement('div');
    typing.className = 'typing';
    typing.setAttribute('aria-live','polite');
    typing.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
    contentEl.appendChild(typing);
    
    // Bloque l'interface
    abortController = new AbortController();
    els.send.disabled = true; 
    els.input.disabled = true; 
    els.stop.classList.remove('hidden'); 
    els.status.textContent = 'L\'IA rÃ©flÃ©chit...';
    
    try{
      const context=await fetchContext(q);
      const reader=await sendToLLM(q, context); 
      const decoder=new TextDecoder(); 
      let done=false; 
      let acc='';
      
      // Retire l'indicateur de typing avant de streamer
      try{ typing.remove(); }catch(e){}
      
      while(!done){ 
        const chunk=await reader.read(); 
        done=chunk.done; 
        if(chunk.value){ 
          const t=decoder.decode(chunk.value,{stream:true}); 
          acc+=t; 
          const html=DOMPurify.sanitize(marked.parse(acc)); 
          textEl.innerHTML=html; 
          autoScroll(); 
        } 
      }
      
      history.push({role:'assistant', content:textEl.textContent});
      if (cfg.activate_source) {
        const histText=history.slice(-5,-1).map(m=>`- ${m.role}: ${m.content}`).join('\n');
        container.appendChild(createSourceBlock(context, histText));
      }
    }catch(e){ 
      // Retire l'indicateur de typing en cas d'erreur aussi
      try{ typing.remove(); }catch(err){}
      textEl.textContent=(textEl.textContent||'')+`\n[Erreur] ${e.message||e}`; 
    }finally{
      // DÃ©bloque l'interface
      els.send.disabled = false; 
      els.input.disabled = false; 
      els.stop.classList.add('hidden'); 
      els.status.textContent = ''; 
      abortController = null;
    }
  }

  els.send.addEventListener('click', handleSend);
  els.stop.addEventListener('click', ()=>{ 
    if(abortController){ 
      abortController.abort(); 
      els.stop.classList.add('hidden'); 
      els.send.disabled=false; 
      els.input.disabled=false; 
      els.status.textContent=''; 
    }
  });
  els.input.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); handleSend(); } });

  // Intercepter les clics sur les liens Brightness Contact
  function setupBrightnessLinks() {
    console.log('ðŸ”§ Setup Brightness Links activÃ©');
    
    // VÃ©rifier que l'Ã©lÃ©ment chat existe
    if (!els.chat) {
      console.error('âŒ Element chat non trouvÃ©!');
      return;
    }
    
    els.chat.addEventListener('click', (e) => {
      console.log('ðŸ–±ï¸ Clic dÃ©tectÃ© dans le chat');
      
      // VÃ©rifier si c'est un lien
      const link = e.target.closest('a');
      if (!link) {
        console.log('âŒ Pas un lien');
        return;
      }
      
      // VÃ©rifier si c'est le lien Brightness Contact
      const href = link.getAttribute('href') || link.href;
      console.log('ðŸ”— Lien cliquÃ©:', href);
      
      // DÃ©tection plus flexible de l'URL Brightness
      const isBrightnessContact = href && (
        href.includes('brightness-institute.fr/contact') ||
        href.includes('brightness.fr/contact') ||
        href === '/contact'
      );
      
      if (isBrightnessContact) {
        console.log('âœ… Lien Brightness dÃ©tectÃ©!');
        e.preventDefault();
        e.stopPropagation();
        
        // VÃ©rifier qu'il y a une conversation
        if (history.length === 0) {
          console.log('âš ï¸ Historique vide');
          window.open(href, '_blank');
          return;
        }
        
        console.log('ðŸ“ Historique:', history.length, 'messages');
        
        // Formatter la conversation
        const dateStr = new Date().toLocaleString('fr-FR', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        // D'abord, construire la conversation COMPLÃˆTE
        const fullConversation = `Conversation du ${dateStr}\n\n` +
          history.map(m => {
            const role = m.role === 'user' ? 'ðŸ‘¤ Client' : 'ðŸ¤– Assistant';
            return `${role}:\n${m.content}`;
          }).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n');
        
        console.log('ðŸ“Š Conversation complÃ¨te:', fullConversation.length, 'caractÃ¨res');
        
        // Encoder la conversation complÃ¨te
        const encodedFull = encodeURIComponent(fullConversation);
        console.log('ðŸ“Š Longueur encodÃ©e:', encodedFull.length, 'caractÃ¨res');
        
        // S'assurer que l'URL est complÃ¨te
        let fullUrl = href;
        if (href === '/contact' || !href.startsWith('http')) {
          fullUrl = 'https://www.brightness-institute.fr/contact';
        }
        
        // Toujours utiliser l'URL (limite trÃ¨s haute)
        if (encodedFull.length < 20000) {
          // MÃ‰THODE URL : Fonctionne pour presque toutes les conversations
          const finalUrl = `${fullUrl}?conversation=${encodedFull}`;
          console.log('ðŸŒ MÃ©thode URL - Conversation COMPLÃˆTE (' + fullConversation.length + ' car., encodÃ©: ' + encodedFull.length + ')');
          els.status.textContent = 'Ouverture du formulaire avec votre conversation complÃ¨te...';
          window.open(finalUrl, '_blank');
        } else {
          // Si vraiment TROP long (trÃ¨s rare)
          console.warn('âš ï¸ Conversation exceptionnellement longue (' + encodedFull.length + ' car. encodÃ©s)');
          const confirmation = confirm('Votre conversation est trÃ¨s longue. Voulez-vous l\'envoyer tronquÃ©e (derniers messages) ?');
          
          if (confirmation) {
            // Tronquer intelligemment en gardant les 15 derniers messages
            const recentHistory = history.slice(-15);
            const truncated = `Conversation du ${dateStr}\n\n[Les 15 derniers messages sur ${history.length} au total]\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n` +
              recentHistory.map(m => {
                const role = m.role === 'user' ? 'ðŸ‘¤ Client' : 'ðŸ¤– Assistant';
                return `${role}:\n${m.content}`;
              }).join('\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n');
            
            const encodedTrunc = encodeURIComponent(truncated);
            const finalUrl = `${fullUrl}?conversation=${encodedTrunc}`;
            console.log('ðŸŒ Version tronquÃ©e envoyÃ©e (15 derniers messages)');
            window.open(finalUrl, '_blank');
          }
          els.status.textContent = '';
        }
        
        setTimeout(() => els.status.textContent = '', 3000);
      }
    });
  }

  async function init(){
    await loadConfig();
    if(cfg.initialisation && cfg.initialisation.trim()){
      const { textEl }=renderMessage('assistant','');
      const html=DOMPurify.sanitize(marked.parse(cfg.initialisation));
      textEl.innerHTML=html;
      history.push({role:'assistant', content:cfg.initialisation});
    }
    // Appeler setupBrightnessLinks aprÃ¨s que tout soit chargÃ©
    setTimeout(() => {
      setupBrightnessLinks();
    }, 100);
  }
  
  init();
})();
</script>
</body>
</html>
