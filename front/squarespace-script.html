<!-- Brightness - Remplissage conversation + Protection + Soumission -->
<script>
(function(){
  'use strict';
  
  console.log('üü¢ Brightness Script V11 - Protection compl√®te');
  
  // Parsing manuel
  function getFromUrl() {
    const search = window.location.search;
    if (!search) return null;
    const match = search.match(/[?&]conversation=([^&]*)/);
    if (match && match[1]) {
      try {
        return decodeURIComponent(match[1]);
      } catch(e) {
        console.log('‚ùå Erreur d√©codage:', e.message);
      }
    }
    return null;
  }
  
  function getFromStorage() {
    if (window.location.hash !== '#chat-export') return null;
    try {
      const stored = localStorage.getItem('brightness_conversation');
      const timestamp = localStorage.getItem('brightness_timestamp');
      if (stored && timestamp && (Date.now() - parseInt(timestamp, 10) < 300000)) {
        localStorage.removeItem('brightness_conversation');
        localStorage.removeItem('brightness_timestamp');
        if (window.history.replaceState) {
          window.history.replaceState(null, null, window.location.pathname);
        }
        return stored;
      }
    } catch(e) {}
    return null;
  }
  
  const conversation = getFromUrl() || getFromStorage();
  
  if (conversation) {
    console.log('‚úÖ Conversation:', conversation.length, 'car.');
    
    // Variable globale pour la conversation
    window._brightnessConversation = conversation;
    
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM charg√©');
      
      setTimeout(function() {
        const textarea = document.querySelector('#textarea-9d89d3c5-7bc9-46d2-8fae-573e726fe183-field');
        
        if (textarea) {
          // Remplir initialement
          textarea.value = conversation;
          console.log('‚úÖ Textarea rempli:', conversation.length, 'car.');
          
          // D√©clencher les √©v√©nements pour que Squarespace voie le changement
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
          textarea.dispatchEvent(new Event('change', { bubbles: true }));
          
          // Focus puis blur pour "valider" le champ
          textarea.focus();
          setTimeout(() => textarea.blur(), 50);
          
          // PROTECTION 1 : Surveiller les changements de valeur
          let userIsTyping = false;
          let formSubmitting = false;
          
          // D√©tecte quand l'utilisateur tape vraiment
          textarea.addEventListener('keydown', function(e) {
            if (e.isTrusted) {
              console.log('‚å®Ô∏è Utilisateur modifie le texte');
              userIsTyping = true;
            }
          });
          
          // Surveiller toute tentative de modification non-utilisateur
          const protectionInterval = setInterval(function() {
            if (!userIsTyping && !formSubmitting && textarea.value !== conversation) {
              console.log('üõ°Ô∏è Restauration - valeur √©tait:', textarea.value.substring(0, 30));
              textarea.value = conversation;
              textarea.dispatchEvent(new Event('change', { bubbles: true }));
            }
          }, 300);
          
          // PROTECTION 2 : Intercepter la soumission
          const form = textarea.closest('form');
          if (form) {
            // M√©thode 1 : Submit event (capture)
            form.addEventListener('submit', function(e) {
              console.log('üì§ Submit event (capture)');
              formSubmitting = true;
              clearInterval(protectionInterval);
              textarea.value = conversation;
              console.log('üì§ Valeur forc√©e:', conversation.substring(0, 50) + '...');
            }, true);
            
            // M√©thode 2 : Intercepter le onsubmit
            const originalOnsubmit = form.onsubmit;
            form.onsubmit = function(e) {
              console.log('üì§ onsubmit intercept√©');
              formSubmitting = true;
              clearInterval(protectionInterval);
              textarea.value = conversation;
              console.log('üì§ Valeur forc√©e (onsubmit)');
              
              if (originalOnsubmit) {
                return originalOnsubmit.call(this, e);
              }
              return true;
            };
            
            // M√©thode 3 : Bouton submit (click AVANT soumission)
            const submitBtn = form.querySelector('input[type="submit"]');
            if (submitBtn) {
              submitBtn.addEventListener('mousedown', function(e) {
                console.log('üì§ MouseDown sur Submit');
                formSubmitting = true;
                clearInterval(protectionInterval);
                textarea.value = conversation;
                console.log('üì§ Valeur forc√©e (mousedown)');
              }, true);
            }
            
            // M√©thode 4 : Intercepter FormData (le plus fiable pour Squarespace)
            const originalFormData = window.FormData;
            window.FormData = function(...args) {
              const formData = new originalFormData(...args);
              const originalAppend = formData.append;
              const originalSet = formData.set;
              
              formData.append = function(name, value, filename) {
                console.log('üìã FormData.append:', name);
                return originalAppend.call(this, name, value, filename);
              };
              
              formData.set = function(name, value, filename) {
                console.log('üìã FormData.set:', name);
                return originalSet.call(this, name, value, filename);
              };
              
              // Ajouter notre champ si c'est notre formulaire
              const originalGet = formData.get.bind(formData);
              formData.get = function(name) {
                const val = originalGet(name);
                if (name === 'textarea-9d89d3c5-7bc9-46d2-8fae-573e726fe183-field' || name.includes('textarea')) {
                  console.log('üîç FormData.get(' + name + '):', val ? val.substring(0, 30) + '...' : 'vide');
                  // Si vide ou manquant, forcer notre valeur
                  if (!val || val === '') {
                    console.log('üî¥ FOR√áAGE de la valeur dans FormData!');
                    formData.set(name, conversation);
                    return conversation;
                  }
                }
                return val;
              };
              
              return formData;
            };
            
            console.log('‚úÖ Interceptions install√©es (4 m√©thodes)');
          }
          
          // Scroll
          setTimeout(() => {
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 500);
          
          // Bandeau
          if (form && !form.querySelector('.brightness-notice')) {
            const notice = document.createElement('div');
            notice.className = 'brightness-notice';
            notice.style.cssText = 'background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:15px 0;border-radius:8px;font-size:14px;';
            notice.innerHTML = '<strong>‚úì Conversation import√©e</strong><br>Votre √©change a √©t√© pr√©-rempli dans "Demande sp√©cifique".';
            
            const firstField = form.querySelector('.field-list');
            if (firstField) {
              form.insertBefore(notice, firstField);
            }
          }
        } else {
          console.log('‚ùå Textarea non trouv√©');
        }
      }, 2000);
    });
  } else {
    console.log('‚ÑπÔ∏è Pas de conversation');
  }
})();
</script>
<!-- FIN Brightness -->
