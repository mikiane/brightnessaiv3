<!-- Brightness - Remplissage conversation dans formulaire -->
<script>
    (function(){
      'use strict';
      
      console.log('üü¢ Brightness Script V16 - Simulation saisie native');
      
      // Parsing manuel du param√®tre conversation
      function getConversation() {
        const search = window.location.search;
        if (!search) return null;
        
        const match = search.match(/[?&]conversation=([^&]*)/);
        if (match && match[1]) {
          try {
            const decoded = decodeURIComponent(match[1]);
            console.log('‚úÖ Conversation trouv√©e:', decoded.length, 'caract√®res');
            return decoded;
          } catch(e) {
            console.log('‚ùå Erreur d√©codage:', e.message);
          }
        }
        
        console.log('‚ÑπÔ∏è Pas de conversation dans l\'URL');
        return null;
      }
      
      const conversation = getConversation();
      
      // Fonction pour simuler une vraie saisie utilisateur (compatible Squarespace)
      function setNativeValue(element, value) {
        const valueSetter = Object.getOwnPropertyDescriptor(element.__proto__, 'value').set;
        const prototype = Object.getPrototypeOf(element);
        const prototypeValueSetter = Object.getOwnPropertyDescriptor(prototype, 'value').set;
        
        if (valueSetter && valueSetter !== prototypeValueSetter) {
          prototypeValueSetter.call(element, value);
        } else {
          valueSetter.call(element, value);
        }
        
        // D√©clencher tous les √©v√©nements n√©cessaires pour Squarespace
        element.dispatchEvent(new Event('input', { bubbles: true, cancelable: true }));
        element.dispatchEvent(new Event('change', { bubbles: true, cancelable: true }));
        element.dispatchEvent(new KeyboardEvent('keyup', { bubbles: true, cancelable: true }));
        element.dispatchEvent(new Event('blur', { bubbles: true, cancelable: true }));
        
        console.log('‚úÖ Valeur d√©finie de mani√®re native');
      }
      
      if (conversation) {
        // Variable globale pour l'interception
        window._brightnessConversation = conversation;
        window._brightnessProtectionActive = true;
        
        window.addEventListener('DOMContentLoaded', function() {
          console.log('üìÑ DOM charg√©, recherche du textarea...');
          
          setTimeout(function() {
            const textarea = document.querySelector('#textarea-9d89d3c5-7bc9-46d2-8fae-573e726fe183-field');
            
            if (textarea) {
              // Fonction pour forcer la valeur avec simulation native
              function forceValue() {
                if (window._brightnessProtectionActive && textarea.value !== conversation) {
                  setNativeValue(textarea, conversation);
                  console.log('üîí Valeur restaur√©e (native)');
                }
              }
              
              // === REMPLISSAGE INITIAL avec d√©lai pour Squarespace ===
              setTimeout(function() {
                setNativeValue(textarea, conversation);
                console.log('‚úÖ Textarea rempli avec', conversation.length, 'caract√®res (mode natif)');
                
                // Forcer focus puis blur pour valider
                textarea.focus();
                setTimeout(function() {
                  textarea.blur();
                }, 100);
              }, 100);
              
              // === PROTECTION CONTINUE : MutationObserver ===
              const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                  if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                    forceValue();
                  }
                });
              });
              observer.observe(textarea, { attributes: true, attributeOldValue: true });
              console.log('‚úÖ MutationObserver install√©');
              
              // === PROTECTION CONTINUE : Surveillance p√©riodique ===
              const watchInterval = setInterval(function() {
                forceValue();
              }, 500);
              console.log('‚úÖ Surveillance p√©riodique activ√©e (500ms)');
              
              // === PROTECTION : √âv√©nements du formulaire ===
              const form = textarea.closest('form');
              if (form) {
                // Surveiller tous les champs du formulaire
                const allInputs = form.querySelectorAll('input, select, textarea');
                allInputs.forEach(function(input) {
                  if (input !== textarea) {
                    input.addEventListener('focus', forceValue);
                    input.addEventListener('blur', forceValue);
                    input.addEventListener('change', forceValue);
                    input.addEventListener('input', forceValue);
                  }
                });
                console.log('‚úÖ Protection sur', allInputs.length, 'champs du formulaire');
                
                // === INTERCEPTION SOUMISSION ULTRA RENFORC√âE ===
                
                // Stocker le name/id du textarea pour FormData
                const textareaFieldName = textarea.getAttribute('name') || textarea.id;
                console.log('üîë Nom du champ textarea:', textareaFieldName);
                
                // === INTERCEPTION FormData GLOBALE ===
                const originalFormData = window.FormData;
                window.FormData = function(formElement) {
                  console.log('üì¶ NEW FormData appel√©');
                  const formData = new originalFormData(formElement);
                  
                  // Logger tout le contenu pour debug
                  console.log('üì¶ FormData cr√©√©, inspection...');
                  for (let pair of formData.entries()) {
                    console.log('  üìã', pair[0], '=', pair[1] ? pair[1].substring(0, 50) + '...' : '(vide)');
                  }
                  
                  // Si le textarea est vide dans le FormData, forcer notre conversation
                  const currentValue = formData.get(textareaFieldName);
                  if (!currentValue || currentValue !== conversation) {
                    console.log('‚ö†Ô∏è Champ manquant ou diff√©rent, injection de la conversation');
                    formData.set(textareaFieldName, conversation);
                    console.log('‚úÖ Conversation inject√©e dans FormData');
                  }
                  
                  return formData;
                };
                console.log('‚úÖ FormData globalement intercept√©');
                
                // === INTERCEPTION XMLHttpRequest.send ===
                const originalXHRSend = XMLHttpRequest.prototype.send;
                
                XMLHttpRequest.prototype.send = function(data) {
                  console.log('üåê XHR.send() intercept√©');
                  console.log('üåê Type de data:', data ? data.constructor.name : 'null');
                  
                  // Si c'est un FormData, injecter la conversation
                  if (data && data.constructor.name === 'FormData') {
                    console.log('üåê C\'est un FormData!');
                    const currentValue = data.get(textareaFieldName);
                    console.log('üåê Valeur actuelle du champ:', currentValue ? currentValue.substring(0, 50) + '...' : '(vide)');
                    
                    if (!currentValue || currentValue !== conversation) {
                      data.set(textareaFieldName, conversation);
                      console.log('‚úÖ Conversation inject√©e dans XHR FormData');
                    }
                  }
                  
                  // Aussi forcer dans le textarea DOM au cas o√π
                  setNativeValue(textarea, conversation);
                  console.log('‚úÖ Textarea DOM forc√© avant XHR');
                  
                  return originalXHRSend.call(this, data);
                };
                
                // === INTERCEPTION fetch ===
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                  console.log('üåê fetch() intercept√©');
                  console.log('üåê URL:', url);
                  
                  if (options && options.body) {
                    console.log('üåê Body type:', options.body.constructor.name);
                    
                    if (options.body.constructor.name === 'FormData') {
                      console.log('üåê C\'est un FormData dans fetch!');
                      const currentValue = options.body.get(textareaFieldName);
                      console.log('üåê Valeur actuelle:', currentValue ? currentValue.substring(0, 50) + '...' : '(vide)');
                      
                      if (!currentValue || currentValue !== conversation) {
                        options.body.set(textareaFieldName, conversation);
                        console.log('‚úÖ Conversation inject√©e dans fetch FormData');
                      }
                    }
                  }
                  
                  // Forcer dans le DOM aussi
                  setNativeValue(textarea, conversation);
                  console.log('‚úÖ Textarea DOM forc√© avant fetch');
                  
                  return originalFetch.apply(this, arguments);
                };
                
                // === INTERCEPTION √©v√©nements submit ===
                form.addEventListener('submit', function(e) {
                  console.log('üì§ SUBMIT (capture) - For√ßage final');
                  setNativeValue(textarea, conversation);
                  
                  // Surveillance hyper-aggressive pendant 3 secondes
                  const hyperWatch = setInterval(function() {
                    if (textarea.value !== conversation) {
                      setNativeValue(textarea, conversation);
                      console.log('üîí Restauration hyper-agressive');
                    }
                  }, 50);
                  
                  setTimeout(function() { clearInterval(hyperWatch); }, 3000);
                }, true);
                
                form.addEventListener('submit', function(e) {
                  console.log('üì§ SUBMIT (bubble) - For√ßage final');
                  setNativeValue(textarea, conversation);
                }, false);
                
                console.log('‚úÖ Toutes les interceptions install√©es');
              }
              
              // === PROTECTION : √âv√©nements directs sur textarea ===
              textarea.addEventListener('blur', function() {
                setTimeout(forceValue, 50);
              });
              textarea.addEventListener('change', function() {
                setTimeout(forceValue, 50);
              });
              
              // === PROTECTION : Clic sur textarea (au cas o√π l'utilisateur voudrait √©diter) ===
              let userIsEditing = false;
              textarea.addEventListener('focus', function() {
                console.log('üë§ Focus sur textarea');
                userIsEditing = true;
                setTimeout(function() { userIsEditing = false; }, 5000); // D√©lai de 5s pour √©diter
              });
              
              textarea.addEventListener('keydown', function() {
                console.log('‚å®Ô∏è Utilisateur tape dans le textarea');
                userIsEditing = true;
                setTimeout(function() { userIsEditing = false; }, 5000);
              });
              
              // Modifier la fonction forceValue pour ne pas √©craser si l'utilisateur √©dite
              const originalForceValue = forceValue;
              forceValue = function() {
                if (!userIsEditing) {
                  originalForceValue();
                }
              };
              
              // Scroll vers le champ
              setTimeout(() => {
                textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 500);
              
              // Bandeau de confirmation avec bouton debug
              if (form && !form.querySelector('.brightness-notice')) {
                const notice = document.createElement('div');
                notice.className = 'brightness-notice';
                notice.style.cssText = 'background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:15px 0;border-radius:8px;font-size:14px;font-family:system-ui;';
                notice.innerHTML = '<strong>‚úì Conversation import√©e (mode natif)</strong><br>Votre √©change a √©t√© pr√©-rempli dans "Demande sp√©cifique". Vous pouvez pr√©ciser certains points si vous le souhaitez.';
                
                const firstField = form.querySelector('.field-list');
                if (firstField) {
                  form.insertBefore(notice, firstField);
                }
                
                console.log('‚úÖ Bandeau affich√©');
              }
            } else {
              console.log('‚ùå Textarea non trouv√©');
              console.log('   Textareas disponibles:', document.querySelectorAll('textarea').length);
            }
          }, 2000);
        });
      }
    })();
    </script>
    <!-- FIN Brightness -->