<!-- Brightness - Remplissage conversation dans formulaire -->
<script>
(function(){
  'use strict';
  
  console.log('üü¢ Brightness Script V13 - Simple + Soumission');
  
  // Parsing manuel du param√®tre conversation
  function getConversation() {
    const search = window.location.search;
    if (!search) return null;
    
    const match = search.match(/[?&]conversation=([^&]*)/);
    if (match && match[1]) {
      try {
        const decoded = decodeURIComponent(match[1]);
        console.log('‚úÖ Conversation trouv√©e:', decoded.length, 'caract√®res');
        return decoded;
      } catch(e) {
        console.log('‚ùå Erreur d√©codage:', e.message);
      }
    }
    
    console.log('‚ÑπÔ∏è Pas de conversation dans l\'URL');
    return null;
  }
  
  const conversation = getConversation();
  
  if (conversation) {
    // Variable globale pour l'interception
    window._brightnessConversation = conversation;
    
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM charg√©, recherche du textarea...');
      
      setTimeout(function() {
        const textarea = document.querySelector('#textarea-9d89d3c5-7bc9-46d2-8fae-573e726fe183-field');
        
        if (textarea) {
          // === REMPLISSAGE SIMPLE (celui qui marchait) ===
          textarea.value = conversation;
          
          // D√©clencher les √©v√©nements
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
          textarea.dispatchEvent(new Event('change', { bubbles: true }));
          
          console.log('‚úÖ Textarea rempli avec', conversation.length, 'caract√®res');
          
          // === AJOUT : INTERCEPTION SOUMISSION pour l'email ===
          const form = textarea.closest('form');
          if (form) {
            // Intercepter au moment du submit
            form.addEventListener('submit', function(e) {
              console.log('üì§ SOUMISSION D√âTECT√âE');
              // Re-forcer la valeur juste avant l'envoi
              textarea.value = window._brightnessConversation;
              console.log('üì§ Valeur forc√©e avant envoi:', textarea.value.substring(0, 50) + '...');
            }, true); // Capture phase = ex√©cut√© AVANT Squarespace
            
            // Intercepter aussi le onsubmit
            const originalOnsubmit = form.onsubmit;
            form.onsubmit = function(e) {
              console.log('üì§ onsubmit intercept√©');
              textarea.value = window._brightnessConversation;
              console.log('üì§ Valeur forc√©e (onsubmit)');
              
              if (originalOnsubmit) {
                return originalOnsubmit.call(this, e);
              }
              return true;
            };
            
            console.log('‚úÖ Interception soumission install√©e');
          }
          
          // Scroll vers le champ
          setTimeout(() => {
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 500);
          
          // Bandeau de confirmation
          if (form && !form.querySelector('.brightness-notice')) {
            const notice = document.createElement('div');
            notice.className = 'brightness-notice';
            notice.style.cssText = 'background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:15px 0;border-radius:8px;font-size:14px;font-family:system-ui;';
            notice.innerHTML = '<strong>‚úì Conversation import√©e</strong><br>Votre √©change a √©t√© pr√©-rempli dans "Demande sp√©cifique" (' + conversation.length + ' caract√®res).';
            
            const firstField = form.querySelector('.field-list');
            if (firstField) {
              form.insertBefore(notice, firstField);
            }
            
            console.log('‚úÖ Bandeau affich√©');
          }
        } else {
          console.log('‚ùå Textarea non trouv√©');
          console.log('   Textareas disponibles:', document.querySelectorAll('textarea').length);
        }
      }, 2000);
    });
  }
})();
</script>
<!-- FIN Brightness -->
