<script>
/**
 * Script Brightness - R√©cup√©ration conversation chatbot
 * Version: 2.0 - Avec MutationObserver (URL uniquement)
 * 
 * INSTALLATION:
 * 1. Aller dans Squarespace
 * 2. Param√®tres ‚Üí Avanc√© ‚Üí Injection de code
 * 3. Coller ce script dans la section FOOTER
 * 4. Enregistrer
 */

(function() {
  'use strict';
  
  const CONFIG = {
    fieldName: 'SQF_EXPERT',
    debug: true
  };
  
  function log(message, type = 'info') {
    if (!CONFIG.debug) return;
    const prefix = 'ü§ñ [Brightness]';
    console[type](`${prefix} ${message}`);
  }
  
  function getUrlParameter(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }
  
  function fillHiddenField(conversationData) {
    const field = document.querySelector(`input[name="${CONFIG.fieldName}"]`);
    
    if (field) {
      field.value = conversationData;
      log(`‚úÖ Conversation inject√©e: ${conversationData.length} caract√®res`);
      
      // Ajouter un bandeau visuel
      const form = field.closest('form');
      if (form && !form.querySelector('.brightness-notice')) {
        const notice = document.createElement('div');
        notice.className = 'brightness-notice';
        notice.style.cssText = 'background:#e8f5e9;border-left:4px solid #4caf50;padding:12px;margin:15px 0;border-radius:4px;font-size:14px;font-family:system-ui;';
        notice.innerHTML = '<strong>‚úì Conversation import√©e</strong><br>Votre √©change avec l\'assistant a √©t√© pr√©-rempli dans le formulaire.';
        
        // Ins√©rer en haut du formulaire
        const firstElement = form.querySelector('.field-list') || form.firstChild;
        if (firstElement) {
          form.insertBefore(notice, firstElement);
        } else {
          form.appendChild(notice);
        }
      }
      return true;
    } else {
      log(`‚ùå Champ "${CONFIG.fieldName}" non trouv√©`);
      
      // Lister les champs disponibles pour debug
      const allInputs = document.querySelectorAll('input[type="hidden"]');
      if (allInputs.length > 0) {
        log('Champs cach√©s disponibles:');
        allInputs.forEach(inp => log(`  - ${inp.name || inp.id}`));
      }
      
      return false;
    }
  }
  
  function attemptFill(conversationData) {
    // Essai imm√©diat
    if (fillHiddenField(conversationData)) {
      log('Remplissage imm√©diat r√©ussi');
      return;
    }
    
    // Si √©chec, utiliser MutationObserver
    log('üîç MutationObserver activ√© - attente du formulaire...');
    
    let attempts = 0;
    const maxAttempts = 20; // 10 secondes max
    
    const observer = new MutationObserver((mutations, obs) => {
      attempts++;
      
      const field = document.querySelector(`input[name="${CONFIG.fieldName}"]`);
      if (field) {
        log(`‚úÖ Formulaire d√©tect√© apr√®s ${attempts} tentatives`);
        fillHiddenField(conversationData);
        obs.disconnect();
      } else if (attempts >= maxAttempts) {
        log('‚è±Ô∏è Timeout: formulaire non d√©tect√© apr√®s 10s', 'warn');
        obs.disconnect();
      }
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // V√©rification p√©riodique toutes les 500ms
    const interval = setInterval(() => {
      const field = document.querySelector(`input[name="${CONFIG.fieldName}"]`);
      if (field) {
        clearInterval(interval);
        observer.disconnect();
        fillHiddenField(conversationData);
      }
    }, 500);
    
    // Nettoyage apr√®s 10s
    setTimeout(() => {
      clearInterval(interval);
      observer.disconnect();
    }, 10000);
  }
  
  // Initialisation
  log('Script initialis√©');
  log('URL: ' + window.location.href);
  
  // R√©cup√©rer la conversation depuis l'URL
  const conversationData = getUrlParameter('conversation');
  
  if (conversationData) {
    try {
      const decoded = decodeURIComponent(conversationData);
      log(`Conversation trouv√©e dans URL (${decoded.length} caract√®res)`);
      
      // Attendre que le DOM soit pr√™t
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => attemptFill(decoded), 500);
        });
      } else {
        setTimeout(() => attemptFill(decoded), 500);
      }
    } catch (e) {
      log('‚ùå Erreur d√©codage URL: ' + e.message, 'error');
    }
  } else {
    log('Aucune conversation dans l\'URL');
  }
})();
</script>

