<!-- Brightness - Remplissage conversation dans formulaire -->
<script>
(function(){
  'use strict';
  
  console.log('üü¢ Brightness Script V8 - Textarea + localStorage');
  
  // Parsing manuel du param√®tre conversation (URL)
  function getFromUrl() {
    const search = window.location.search;
    if (!search) return null;
    
    const match = search.match(/[?&]conversation=([^&]*)/);
    if (match && match[1]) {
      try {
        const decoded = decodeURIComponent(match[1]);
        console.log('‚úÖ Conversation URL:', decoded.length, 'caract√®res');
        return decoded;
      } catch(e) {
        console.log('‚ùå Erreur d√©codage URL:', e.message);
      }
    }
    return null;
  }
  
  // R√©cup√©ration depuis localStorage
  function getFromStorage() {
    if (window.location.hash !== '#chat-export') return null;
    
    try {
      const stored = localStorage.getItem('brightness_conversation');
      const timestamp = localStorage.getItem('brightness_timestamp');
      
      if (stored && timestamp) {
        const age = Date.now() - parseInt(timestamp, 10);
        
        if (age < 300000) { // 5 minutes
          console.log('üíæ Conversation localStorage:', stored.length, 'caract√®res');
          // Nettoyer imm√©diatement
          localStorage.removeItem('brightness_conversation');
          localStorage.removeItem('brightness_timestamp');
          
          // Nettoyer l'URL
          if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.pathname);
          }
          
          return stored;
        } else {
          console.log('‚è±Ô∏è Conversation expir√©e (> 5 min)');
          localStorage.removeItem('brightness_conversation');
          localStorage.removeItem('brightness_timestamp');
        }
      }
    } catch(e) {
      console.log('‚ùå Erreur localStorage:', e.message);
    }
    return null;
  }
  
  const conversation = getFromUrl() || getFromStorage();
  
  if (conversation) {
    // Attendre que le DOM soit pr√™t
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM charg√©, recherche du textarea...');
      
      setTimeout(function() {
        // Trouver le textarea "Demande sp√©cifique" par son ID
        const textarea = document.querySelector('#textarea-9d89d3c5-7bc9-46d2-8fae-573e726fe183-field');
        
        if (textarea) {
          // Remplir le champ
          textarea.value = conversation;
          
          // D√©clencher les √©v√©nements pour que Squarespace d√©tecte le changement
          textarea.dispatchEvent(new Event('input', { bubbles: true }));
          textarea.dispatchEvent(new Event('change', { bubbles: true }));
          
          console.log('‚úÖ Textarea rempli avec', conversation.length, 'caract√®res');
          
          // Scroll vers le champ pour que l'utilisateur le voie
          setTimeout(() => {
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 500);
          
          // Ajouter un bandeau de confirmation
          const form = textarea.closest('form');
          if (form && !form.querySelector('.brightness-notice')) {
            const notice = document.createElement('div');
            notice.className = 'brightness-notice';
            notice.style.cssText = 'background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:15px 0;border-radius:8px;font-size:14px;font-family:system-ui;';
            notice.innerHTML = '<strong>‚úì Conversation compl√®te import√©e</strong><br>Votre √©change avec l\'assistant a √©t√© pr√©-rempli dans "Demande sp√©cifique" (' + conversation.length + ' caract√®res).';
            
            const firstField = form.querySelector('.field-list');
            if (firstField) {
              form.insertBefore(notice, firstField);
            }
            
            console.log('‚úÖ Bandeau de confirmation affich√©');
          }
        } else {
          console.log('‚ùå Textarea "Demande sp√©cifique" non trouv√©');
          console.log('   Textareas disponibles:', document.querySelectorAll('textarea').length);
          
          // Liste tous les textareas pour debug
          document.querySelectorAll('textarea').forEach(ta => {
            console.log('   - ID:', ta.id, 'Name:', ta.name);
          });
        }
      }, 2000); // 2 secondes pour √™tre s√ªr que le formulaire est charg√©
    });
  }
})();
</script>
<!-- FIN Brightness -->
