<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat RAG</title>
  <style>
    :root{ --bg:#0B0B0C; --panel:#15161A; --muted:#24262B; --text:#E8E9EC; --accent:#D73C2C; --subtle:#9AA0A6; --radius:10px; --shadow:0 4px 20px rgba(0,0,0,.35); }
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    .wrap{display:flex; flex-direction:column; height:100vh; overflow:hidden}
    header{display:flex; gap:10px; align-items:center; padding:10px 14px; border-bottom:1px solid var(--muted); background:var(--panel); flex-shrink:0}
    header img{height:28px}
    main{flex:1; display:flex; flex-direction:column; max-width:900px; margin:0 auto; width:100%; overflow:hidden; padding-bottom:140px}
    .chat{flex:1; padding:14px; overflow-y:auto; overflow-x:hidden}
    .msg{display:flex; gap:10px; margin:10px 0}
    .role{width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff}
    .role.user{background:#3A3F46}
    .role.assistant{background:var(--accent)}
    .content{max-width:100%}
    .content.user{white-space:pre-wrap}
    .content.md{white-space:normal}
    .content.md pre{background:#0f1115; border:1px solid var(--muted); padding:10px; overflow:auto; border-radius:6px}
    .content.md code{background:#0f1115; padding:2px 4px; border-radius:4px}
    .content.md ul, .content.md ol{margin:8px 0 8px 22px}
    .content.md a{color:var(--accent); font-weight:700; text-decoration:none}
    .content.md a:hover{text-decoration:underline}
    .composer{position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:900px; padding:10px 14px; border-top:1px solid var(--muted); background:var(--panel); z-index:100; box-sizing:border-box}
    .row{display:flex; gap:10px; align-items:center}
    textarea{flex:1; resize:vertical; min-height:60px; max-height:150px; border:1px solid var(--muted); background:var(--panel); color:var(--text); border-radius:var(--radius); padding:10px; box-shadow:var(--shadow)}
    .btn{border:1px solid var(--muted); background:var(--panel); color:var(--text); padding:10px 12px; border-radius:var(--radius); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, var(--accent), #b32f23); border:none; color:#fff}
    .hidden{display:none}
    .hint{color:var(--subtle); font-size:12px}
    /* Bloc source (contexte) */
    .source{border:1px solid var(--muted); border-radius:8px; margin-top:8px; overflow:hidden; background:rgba(255,255,255,.02)}
    .source-toggle{padding:3px 6px; font-size:11px; color:var(--subtle); cursor:pointer; user-select:none; background:transparent}
    .source-toggle:hover{color:#C2C7CE}
    .source-panel{display:none; padding:8px 10px; color:var(--subtle); font-size:12px; line-height:1.35}
    .source.open .source-panel{display:block}
    .sec-title{font-weight:600; font-size:11px; color:#80868b; text-transform:uppercase; letter-spacing:.3px}
    .chunk{border:1px dashed #2a2d33; border-radius:6px; padding:6px; margin-top:6px; background:transparent}
    /* Typing indicator */
    .typing{display:inline-flex;gap:4px;align-items:center;margin-top:4px}
    .typing .dot{width:6px;height:6px;background:#9AA0A6;border-radius:50%;opacity:.3;animation:blink 1.2s infinite}
    .typing .dot:nth-child(2){animation-delay:.2s}
    .typing .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}
    /* Images inline fournies par le LLM */
    .content.md img{max-width:100%;height:auto;border-radius:8px;margin:12px 0;box-shadow:var(--shadow);border:1px solid var(--muted);display:block}
    .content.md img:hover{border-color:var(--accent);transition:border-color .2s ease}
    /* Cards pour les liens externes */
    .link-card{display:block;margin:12px 0;border:1px solid var(--muted);border-radius:8px;overflow:hidden;background:var(--panel);text-decoration:none;transition:all .2s ease;cursor:pointer}
    .link-card:hover{border-color:var(--accent);box-shadow:var(--shadow);transform:translateY(-2px)}
    .link-card-image{width:100%;height:180px;object-fit:cover;background:linear-gradient(135deg,var(--muted),var(--panel));position:relative}
    .link-card-title{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));color:#fff;padding:12px;font-weight:600;font-size:14px}
    .link-card-body{padding:12px}
    .link-card-url{font-size:11px;color:var(--subtle);text-overflow:ellipsis;overflow:hidden;white-space:nowrap}
    .link-card-loading{display:flex;align-items:center;justify-content:center;height:180px;color:var(--subtle);font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <img id="logo" alt="logo" />
    <div id="title">Chat RAG</div>
  </header>
  <main>
    <section id="chat" class="chat" aria-live="polite"></section>
  </main>
  <footer class="composer">
    <div class="row">
      <textarea id="input" placeholder="Votre question‚Ä¶ (Entr√©e = envoyer)"></textarea>
      <button id="stop" class="btn hidden">Stop</button>
      <button id="send" class="btn primary">Envoyer</button>
    </div>
    <div class="row"><span id="status" class="hint"></span></div>
  </footer>
</div>
<script>
(function(){
  const els = { logo:document.getElementById('logo'), title:document.getElementById('title'), chat:document.getElementById('chat'), input:document.getElementById('input'), send:document.getElementById('send'), stop:document.getElementById('stop'), status:document.getElementById('status') };
  let abortController = null;

  let cfg = { title:'Chat RAG', logoUrl:'', apiUrl:'', searchUrl:'', apiKey:'', brain_id:'', model:'', temperature:0, withHistory:true, system:'', consigne:'', activate_source:false, initialisation:'' };

  async function loadConfig(){
    const params=new URLSearchParams(window.location.search); const idx=params.get('index'); let cfgFile='chat-config.json';
    if(idx){ const safe=idx.match(/^[a-zA-Z0-9_-]+(\.json)?$/)?idx:null; if(safe) cfgFile=safe.endsWith('.json')?safe:`${safe}.json`; }
    try{ const res=await fetch(cfgFile,{cache:'no-store'}); if(!res.ok) throw 0; cfg={...cfg,...(await res.json())}; }catch(e){ try{ const r2=await fetch('chat-config.json',{cache:'no-store'}); if(r2.ok) cfg={...cfg,...(await r2.json())}; }catch(_){} }
    if(cfg.title) els.title.textContent=cfg.title; if(cfg.logoUrl) els.logo.src=cfg.logoUrl; else els.logo.classList.add('hidden');
    if(!cfg.apiUrl) els.status.textContent='Configuration manquante: apiUrl'; if(!cfg.searchUrl) els.status.textContent='Configuration manquante: searchUrl'; if(!cfg.brain_id) els.status.textContent='Configuration manquante: brain_id';
  }

  function atBottom(c,t=150){ return c.scrollHeight-c.scrollTop-c.clientHeight<t; }
  function autoScroll(){ els.chat.scrollTop=els.chat.scrollHeight; }
  function $(tag, attrs={}, text=''){ const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>n.setAttribute(k,v)); if(text) n.textContent=text; return n; }
  function renderMessage(role, content){
    const container=$('div',{class:'msg'});
    const roleEl=$('div',{class:'role '+(role==='assistant'?'assistant':'user')}); roleEl.textContent=role==='assistant'?'AI':'Vous';
    const contentEl=$('div');
    const textEl=$('div',{class:'content '+(role==='assistant'?'md':'user')}); if(role==='assistant') textEl.innerHTML=''; else textEl.textContent=content||'';
    contentEl.appendChild(textEl);
    container.appendChild(roleEl); container.appendChild(contentEl); els.chat.appendChild(container); if(atBottom(els.chat)) autoScroll();
    return { textEl, container, contentEl };
  }

  function createSourceBlock(contextText, histText){
    const wrap=$('div',{class:'source'}); const toggle=$('div',{class:'source-toggle'},'source'); const panel=$('div',{class:'source-panel'});
    const histTitle=$('div',{class:'sec-title'},'Historique'); const hist=$('div',{class:'chunk'}); hist.textContent=(histText||'(vide)'); panel.appendChild(histTitle); panel.appendChild(hist);
    const parts=Array.isArray(contextText)?contextText: typeof contextText==='string'?contextText.split(/\n\s*\n+/):[String(contextText||'')];
    const exTitle=$('div',{class:'sec-title'},`Extraits (${parts.length})`); panel.appendChild(exTitle);
    parts.forEach(p=>{ const c=$('div',{class:'chunk'}); c.textContent=p.trim(); panel.appendChild(c); });
    toggle.addEventListener('click',()=>wrap.classList.toggle('open')); wrap.appendChild(toggle); wrap.appendChild(panel); return wrap;
  }

  // ============================================
  // FONCTIONS AFFICHAGE IMAGES ET LINKS CARDS
  // ============================================

  function setupImageErrorHandling(container){
    const images=container.querySelectorAll('img');
    images.forEach(img=>{
      img.loading='lazy';
      img.onerror=()=>{
        console.warn(`‚ùå Image cass√©e, suppression: ${img.src}`);
        const parent=img.parentElement;
        img.remove();
        if(parent&&parent.childNodes.length===0&&parent.tagName==='P'){
          parent.remove();
        }
      };
      img.onload=()=>{
        console.log(`‚úÖ Image charg√©e: ${img.src}`);
        if(atBottom(els.chat))autoScroll();
      };
    });
  }

  function extractWebUrls(text){
    const urlPattern=/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)/gi;
    const imagePattern=/\.(?:jpg|jpeg|png|gif|webp|svg)(?:\?[^\s]*)?$/i;
    const urls=[...text.matchAll(urlPattern)].map(m=>m[0]);
    return[...new Set(urls)].filter(url=>!imagePattern.test(url));
  }

  async function fetchLinkMetadata(url){
    try{
      const response=await fetch(`https://api.microlink.io/?url=${encodeURIComponent(url)}`,{
        timeout:5000
      });
      if(!response.ok){
        console.warn(`‚ùå √âchec r√©cup√©ration m√©tadonn√©es (${response.status}): ${url}`);
        return null;
      }
      const data=await response.json();
      if(!data.status||data.status==='error'||!data.data){
        console.warn(`‚ùå M√©tadonn√©es invalides: ${url}`);
        return null;
      }
      const title=data.data?.title;
      const image=data.data?.image?.url;
      if(!title||title.length<3){
        console.warn(`‚ùå Titre invalide: ${url}`);
        return null;
      }
      return{
        title:title,
        image:image||null,
        description:data.data?.description||'',
        url:url
      };
    }catch(error){
      console.warn(`‚ùå Erreur r√©seau pour ${url}:`,error);
      return null;
    }
  }

  function createLinkCard(metadata){
    const card=document.createElement('a');
    card.className='link-card';
    card.href=metadata.url;
    card.target='_blank';
    card.rel='noopener noreferrer';
    if(metadata.image){
      const testImg=new Image();
      testImg.onload=()=>{
        const imageDiv=document.createElement('div');
        imageDiv.className='link-card-image';
        imageDiv.style.backgroundImage=`url('${metadata.image}')`;
        imageDiv.style.backgroundSize='cover';
        imageDiv.style.backgroundPosition='center';
        const titleOverlay=document.createElement('div');
        titleOverlay.className='link-card-title';
        titleOverlay.textContent=metadata.title;
        imageDiv.appendChild(titleOverlay);
        card.insertBefore(imageDiv,card.firstChild);
      };
      testImg.onerror=()=>{
        console.warn(`‚ùå Image de card cass√©e: ${metadata.image}`);
      };
      testImg.src=metadata.image;
    }
    const body=document.createElement('div');
    body.className='link-card-body';
    const title=document.createElement('div');
    title.style.fontWeight='600';
    title.style.marginBottom='4px';
    title.textContent=metadata.title;
    body.appendChild(title);
    const urlDiv=document.createElement('div');
    urlDiv.className='link-card-url';
    urlDiv.textContent=metadata.url;
    body.appendChild(urlDiv);
    card.appendChild(body);
    return card;
  }

  async function enrichWithLinkCards(container){
    const links=container.querySelectorAll('a[href^="http"]');
    for(const link of links){
      const url=link.href;
      if(/\.(?:jpg|jpeg|png|gif|webp|svg)(?:\?[^\s]*)?$/i.test(url))continue;
      console.log(`üîó Tentative de cr√©ation d'une card pour: ${url}`);
      try{
        const metadata=await fetchLinkMetadata(url);
        if(!metadata){
          console.log(`‚ö†Ô∏è Pas de m√©tadonn√©es, lien normal conserv√©: ${url}`);
          continue;
        }
        const card=createLinkCard(metadata);
        link.parentNode.replaceChild(card,link);
        console.log(`‚úÖ Card cr√©√©e pour: ${url}`);
        if(atBottom(els.chat))autoScroll();
      }catch(error){
        console.warn(`‚ùå Erreur cr√©ation card pour ${url}:`,error);
      }
    }
  }

  const history=[];
  function buildConsigne(base, hist){ if(!cfg.withHistory||hist.length===0) return base||''; const last=hist.slice(-4).map(m=>`- ${m.role}: ${m.content}`).join('\n'); return `${base||''}\n\nContexte conversationnel:\n${last}`.trim(); }

  async function fetchContext(q){ const fd=new FormData(); fd.append('request',q); fd.append('brain_id',cfg.brain_id); if(cfg.model) fd.append('model',cfg.model); const headers={}; if(cfg.apiKey) headers['X-API-Key']=cfg.apiKey; const res=await fetch(cfg.searchUrl,{method:'POST',body:fd,headers,signal:abortController?.signal}); if(!res.ok) throw new Error('searchcontext HTTP '+res.status); const data=await res.json(); const ans=Array.isArray(data)?data[0]?.answer:data?.[0]?.answer; return ans||''; }

  async function sendToLLM(question, extraContext){
    const headers={'Content-Type':'application/json','Accept':'text/plain'}; if(cfg.apiKey) headers['X-API-Key']=cfg.apiKey;
    const contextualConsigne=`${buildConsigne(cfg.consigne,history)}\n\nVoici un contexte √† prendre en compte <<<Contexte>>>\n${extraContext}`;
    const payload={ consigne:encodeURIComponent(contextualConsigne), texte:encodeURIComponent(question), system:cfg.system||'', model:cfg.model||undefined, temperature:String(Number(cfg.temperature||0).toFixed(2)) };
    const res=await fetch(cfg.apiUrl,{method:'POST',headers,body:JSON.stringify(payload),mode:'cors',credentials:'omit',signal:abortController?.signal}); if(!res.ok||!res.body) throw new Error('LLM HTTP '+res.status); return res.body.getReader();
  }

  async function handleSend(){
    const q=els.input.value.trim(); if(!q) return; 
    els.input.value=''; els.input.focus();
    renderMessage('user', q); history.push({role:'user', content:q});
    const { textEl, container, contentEl }=renderMessage('assistant','');
    
    // Ajoute l'indicateur de typing
    const typing = document.createElement('div');
    typing.className = 'typing';
    typing.setAttribute('aria-live','polite');
    typing.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
    contentEl.appendChild(typing);
    
    // Bloque l'interface
    abortController = new AbortController();
    els.send.disabled = true; 
    els.input.disabled = true; 
    els.stop.classList.remove('hidden'); 
    els.status.textContent = 'L\'IA r√©fl√©chit...';
    
    try{
      const context=await fetchContext(q);
      const reader=await sendToLLM(q, context); 
      const decoder=new TextDecoder(); 
      let done=false; 
      let acc='';
      
      // Retire l'indicateur de typing avant de streamer
      try{ typing.remove(); }catch(e){}
      
      while(!done){ 
        const chunk=await reader.read(); 
        done=chunk.done; 
        if(chunk.value){ 
          const t=decoder.decode(chunk.value,{stream:true}); 
          acc+=t; 
          const html=DOMPurify.sanitize(marked.parse(acc)); 
          textEl.innerHTML=html; 
          if(atBottom(els.chat)) autoScroll(); 
        } 
      }
      
      history.push({role:'assistant', content:textEl.textContent});
      
      // Gestion des images inline (erreurs de chargement)
      setupImageErrorHandling(textEl);
      
      // Transformation des liens en cards avec preview
      await enrichWithLinkCards(textEl);
      
      if (cfg.activate_source) {
        const histText=history.slice(-5,-1).map(m=>`- ${m.role}: ${m.content}`).join('\n');
        contentEl.appendChild(createSourceBlock(context, histText));
      }
    }catch(e){ 
      // Retire l'indicateur de typing en cas d'erreur aussi
      try{ typing.remove(); }catch(err){}
      textEl.textContent=(textEl.textContent||'')+`\n[Erreur] ${e.message||e}`; 
    }finally{
      // D√©bloque l'interface
      els.send.disabled = false; 
      els.input.disabled = false; 
      els.stop.classList.add('hidden'); 
      els.status.textContent = ''; 
      abortController = null;
    }
  }

  els.send.addEventListener('click', handleSend);
  els.stop.addEventListener('click', ()=>{ 
    if(abortController){ 
      abortController.abort(); 
      els.stop.classList.add('hidden'); 
      els.send.disabled=false; 
      els.input.disabled=false; 
      els.status.textContent=''; 
    }
  });
  els.input.addEventListener('keydown', e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); handleSend(); } });


  async function init(){
    await loadConfig();
    if(cfg.initialisation && cfg.initialisation.trim()){
      const { textEl }=renderMessage('assistant','');
      const html=DOMPurify.sanitize(marked.parse(cfg.initialisation));
      textEl.innerHTML=html;
      history.push({role:'assistant', content:cfg.initialisation});
    }
  }
  
  init();
})();
</script>
</body>
</html>
